param tags object
param appInsightsName string
param location string
param messageMonitorWorkbookDisplayName string
//param workbookSerializedData string = '' // JSON string representing the workbook content

var logAnalyticName = replace(appInsightsName,'appi','log')

var workbookSerializedData = '{"version":"Notebook/1.0","items":[{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"${guid(appInsightsName, messageMonitorWorkbookDisplayName)}","version":"KqlParameterItem/1.0","name":"workspace","label":"Workspace","type":5,"isRequired":true,"typeSettings":{"resourceTypeFilter":{"microsoft.operationalinsights/workspaces":true,"microsoft.insights/components":true},"additionalResourceOptions":[],"showDefault":false},"jsonData":"[\\r\\n    { \\"value\\":\\"/subscriptions/${subscription().subscriptionId}/resourcegroups/${resourceGroup().name}/providers/microsoft.operationalinsights/workspaces/${logAnalyticName}\\", \\"label\\": \\"default\\", \\"selected\\":true, \\"group\\":\\"Analytics\\" }\\r\\n]","timeContext":{"durationMs":86400000}}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"customWidth":"33","name":"parameters - 14","styleSettings":{"maxWidth":"250px"}},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"eda2c251-bc40-4aa0-90f6-bc5990e5762b","version":"KqlParameterItem/1.0","name":"timerange","label":"Time Range","type":4,"isRequired":true,"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}]},"timeContext":{"durationMs":86400000},"value":{"durationMs":604800000}}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"customWidth":"75","name":"parameters - 7","styleSettings":{"maxWidth":"100%"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"AppTraces \\r\\n| where Properties[\'prop__messageMonitor\'] == \\"true\\"\\r\\n| summarize Count = count() by tostring(Properties[\'prop__status\']), bin(TimeGenerated, 1h)\\r\\n| order by TimeGenerated asc\\r\\n","size":1,"title":"Overall Run Status","timeContextFromParameter":"timerange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{workspace}"],"visualization":"areachart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"status_s","formatter":1},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"graphSettings":{"type":0,"topContent":{"columnMatch":"status_s","formatter":1},"centerContent":{"columnMatch":"Count","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"chartSettings":{"showMetrics":false,"seriesLabelSettings":[{"seriesName":"success","color":"green"},{"seriesName":"error","color":"redBright"}],"showDataPoints":true,"ySettings":{"min":0}},"mapSettings":{"locInfo":"LatLong","sizeSettings":"Count","sizeAggregation":"Sum","legendMetric":"Count","legendAggregation":"Sum","itemColorSettings":{"type":"heatmap","colorAggregation":"Sum","nodeColorField":"Count","heatmapPalette":"greenRed"}}},"customWidth":"33","name":"query - 3","styleSettings":{"showBorder":true}},{"type":3,"content":{"version":"KqlItem/1.0","query":"AppTraces \\r\\n| where Properties[\'prop__messageMonitor\'] == \\"true\\"\\r\\n| where TimeGenerated > ago(24h)  // Filter for logs from the last 24 hours\\r\\n| summarize Count=count() by status = case(\\r\\n    Properties[\'prop__status\'] == \\"success\\", \\"Success\\",\\r\\n    \\"Error\\" // Assumes any status other than \\"success\\" is an error\\r\\n  )  // Group and count by status\\r\\n| render piechart","size":1,"title":"Status last 24 hours","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{workspace}"],"chartSettings":{"seriesLabelSettings":[{"seriesName":"Error","color":"redBright"},{"seriesName":"Success","color":"green"}]}},"customWidth":"33","name":"query - 4","styleSettings":{"showBorder":true}},{"type":3,"content":{"version":"KqlItem/1.0","query":"AppTraces \\r\\n| where Properties[\'prop__messageMonitor\'] == \\"true\\"\\r\\n| where Properties[\'prop__status\'] != \\"success\\"  // Assuming a failure is represented by any status other than \\"success\\"\\r\\n| summarize failedCount=count() by OperationName // Count the failures by processName\\r\\n| top 5 by failedCount desc // Get the top 10 processes with the highest failure count","size":1,"title":"Top 5 Failed Processes","noDataMessage":"No failed processes.","noDataMessageStyle":3,"timeContextFromParameter":"timerange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"failedCount","formatter":8,"formatOptions":{"min":0,"palette":"redBright","customColumnWidthSetting":"15ch"}}]},"sortBy":[],"tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"targetName","formatter":1},"leftContent":{"columnMatch":"failedCount","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"graphSettings":{"type":0,"topContent":{"columnMatch":"targetName","formatter":1},"centerContent":{"columnMatch":"failedCount","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"chartSettings":{"showLegend":true}},"customWidth":"33","name":"query - 7","styleSettings":{"showBorder":true}},{"type":1,"content":{"json":"<br>**Message Monitor Search**"},"name":"text - 13"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"8fb71933-5318-4a77-9d50-838944985fe2","version":"KqlParameterItem/1.0","name":"gridSize","label":"Grid Size","type":2,"isRequired":true,"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"jsonData":"[\\"10\\",\\"50\\",\\"100\\",\\"200\\",\\"500\\",\\"1000\\"]","timeContext":{"durationMs":86400000},"value":"200"}],"style":"above","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"customWidth":"0","name":"parameters - 7 - Copy","styleSettings":{"maxWidth":"200px"}},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"7622d171-129a-4584-aa62-66a5bd57bc66","version":"KqlParameterItem/1.0","name":"gridStatus","label":"Status","type":2,"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"jsonData":"[\\"success\\",\\"error\\"]","timeContext":{"durationMs":86400000},"value":null}],"style":"above","queryType":0,"resourceType":"microsoft.insights/components"},"customWidth":"0","name":"parameters - 7 - Copy - Copy","styleSettings":{"maxWidth":"200px"}},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"95436de8-5726-407d-bf3d-9d2f0e00ecc2","version":"KqlParameterItem/1.0","name":"gridSource","label":"Source Name","type":1,"isGlobal":true,"timeContext":{"durationMs":86400000},"value":""}],"style":"above","queryType":0,"resourceType":"microsoft.insights/components"},"customWidth":"0","name":"parameters - 8 - Copy - Copy","styleSettings":{"maxWidth":"200px"}},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"5f3695ab-d004-4e29-93db-61d6b2a4f9c8","version":"KqlParameterItem/1.0","name":"gridTarget","label":"Target Name","type":1,"timeContext":{"durationMs":86400000},"value":""}],"style":"above","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"customWidth":"0","name":"parameters - 8 - Copy - Copy - Copy","styleSettings":{"maxWidth":"200px"}},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"416cc014-80d7-4df6-9d17-46bb581c8d1e","version":"KqlParameterItem/1.0","name":"gridBatch","label":"Batch Id","type":1,"timeContext":{"durationMs":86400000},"value":""}],"style":"above","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"customWidth":"0","name":"parameters - 8 - Copy - Copy - Copy - Copy","styleSettings":{"maxWidth":"200px"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"AppTraces \\r\\n| where Properties[\'prop__messageMonitor\'] == \\"true\\"\\r\\n| where (isempty(\\"{gridSource}\\") or Properties[\'prop__sourceName\'] contains \\"{gridSource}\\")\\r\\n    and (isempty(\\"{gridTarget}\\") or Properties[\'prop__targetName\'] contains \\"{gridTarget}\\")\\r\\n    and (isempty(\\"{gridBatch}\\") or Properties[\'prop__batchId\'] contains \\"{gridBatch}\\")\\r\\n    and (isempty(\\"{gridStatus}\\") or Properties[\'prop__status\'] == \\"{gridStatus}\\")\\r\\n| project TimeGenerated, \\r\\n    status = Properties[\'prop__status\'], \\r\\n    operationId = OperationId, \\r\\n    batchId = Properties[\'prop__batchId\'], \\r\\n    source = strcat(Properties[\'prop__sourceType\'], \\":\\", Properties[\'prop__sourceName\']), \\r\\n    target = strcat(Properties[\'prop__targetType\'], \\":\\", Properties[\'prop__targetName\']),\\r\\n    type = Properties[\'prop__dataObjectTypeName\'],\\r\\n    message = Properties[\'prop__message\'],\\r\\n    processName = strcat(AppRoleName,\'/\', OperationName)\\r\\n| order by TimeGenerated desc \\r\\n| take {gridSize}\\r\\n ","size":0,"title":"Message Monitor","timeContextFromParameter":"timerange","exportedParameters":[{"fieldName":"operationId","parameterName":"correlationId","parameterType":1},{"fieldName":"source","parameterName":"sourceName","parameterType":1},{"fieldName":"target","parameterName":"targetName","parameterType":1},{"fieldName":"processName","parameterName":"processName","parameterType":1},{"fieldName":"message","parameterName":"message","parameterType":1,"defaultValue":"none"},{"fieldName":"status","parameterName":"status","parameterType":1},{"fieldName":"statusCode","parameterName":"statusCode","parameterType":1},{"fieldName":"funcStatusCode","parameterName":"funcStatusCode","parameterType":1}],"showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{workspace}"],"visualization":"table","showExpandCollapseGrid":true,"gridSettings":{"formatters":[{"columnMatch":"status","formatter":11},{"columnMatch":"processName","formatter":5},{"columnMatch":"process_link","formatter":7,"formatOptions":{"linkTarget":"Url"}},{"columnMatch":"payloadUrl","formatter":7,"formatOptions":{"linkTarget":"Url"}},{"columnMatch":"status_s","formatter":11},{"columnMatch":"Message","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkLabel":"","linkIsContextBlade":true}},{"columnMatch":"link","formatter":7,"formatOptions":{"linkTarget":"Url","linkLabel":"HYPERLINK(\\"https://example.com\\", \\"Test\\")"}},{"columnMatch":"p_link","formatter":7,"formatOptions":{"linkTarget":"Url","linkLabel":"Link"}},{"columnMatch":"test","formatter":7,"formatOptions":{"linkTarget":"Url"}}],"rowLimit":1000,"filter":true,"sortBy":[{"itemKey":"TimeGenerated","sortOrder":2}]},"sortBy":[{"itemKey":"TimeGenerated","sortOrder":2}]},"name":"query - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let specificCorrelationId = \\"{correlationId}\\"; \\r\\n\\r\\nlet messageData = AppTraces \\r\\n| where Properties[\'prop__messageMonitor\'] == \\"true\\"\\r\\n| where OperationId == specificCorrelationId\\r\\n| extend SourceNodeId=strcat(OperationId, \\"-Node-\\", Properties[\'prop__sourceName\']), \\r\\n         TargetNodeId=strcat(OperationId, \\"-Node-\\", Properties[\'prop__targetName\']),\\r\\n         ProcessNodeId=strcat(OperationId, \\"-Process-\\", strcat(AppRoleName,\'/\', OperationName))\\r\\n| extend sourceName=tostring(Properties[\'prop__sourceName\']), correlationId=tostring(OperationId), status=tostring(Properties[\'prop__status\']), targetName=tostring(Properties[\'prop__targetName\']), processName=tostring(strcat(AppRoleName,\'/\', OperationName));\\r\\n\\r\\n// Create nodes for sources with color codes based on status\\r\\nlet sourceNodes = messageData \\r\\n| summarize Calls=count(), Status=max(status) by SourceNodeId, sourceName=sourceName, correlationId\\r\\n| project Id=SourceNodeId, Name=sourceName, Calls, Kind=\\"Source\\", CorrelationId=correlationId, Color=iff(Status == \\"success\\", \\"50C878\\", \\"BC544B\\");\\r\\n\\r\\n// Create nodes for targets with color codes based on status\\r\\nlet targetNodes = messageData \\r\\n| summarize Calls=count(), Status=max(status) by TargetNodeId, targetName=targetName, correlationId\\r\\n| project Id=TargetNodeId, Name=targetName, Calls, Kind=\\"Target\\", CorrelationId=correlationId, Color=iff(Status == \\"success\\", \\"50C878\\", \\"BC544B\\");\\r\\n\\r\\n// Create nodes for processes\\r\\nlet processNodes = messageData \\r\\n| summarize Calls=count() by ProcessNodeId, processName=processName, correlationId\\r\\n| project Id=ProcessNodeId, Name=processName, Calls, Kind=\\"Process\\", CorrelationId=correlationId, Color=\\"303030\\";\\r\\n\\r\\n// Union all nodes and deduplicate by Id\\r\\nlet allNodes = union sourceNodes, targetNodes, processNodes\\r\\n| summarize max(Name), sum(Calls), max(Kind), max(CorrelationId), max(Color) by Id\\r\\n| project Id, Name=max_Name, Calls=sum_Calls, Kind=max_Kind, CorrelationId=max_CorrelationId, Color=max_Color;\\r\\n\\r\\n// Create edges between nodes\\r\\nlet sourceToProcessEdges = messageData \\r\\n| project SourceId=SourceNodeId, TargetId=ProcessNodeId;\\r\\n\\r\\nlet processToTargetEdges = messageData \\r\\n| project SourceId=ProcessNodeId, TargetId=TargetNodeId;\\r\\n\\r\\n// Combine distinct nodes and edges into a single output\\r\\nunion allNodes, sourceToProcessEdges, processToTargetEdges","size":0,"title":"Landscape Graph","timeContextFromParameter":"timerange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{workspace}"],"visualization":"graph","graphSettings":{"type":0,"topContent":{"columnMatch":"Name","formatter":1},"centerContent":{"columnMatch":"Calls","formatter":12,"formatOptions":{"palette":"none"},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumFractionDigits":2,"maximumSignificantDigits":3}}},"bottomContent":{"columnMatch":"Kind","formatter":1},"nodeIdField":"Id","sourceIdField":"SourceId","targetIdField":"TargetId","graphOrientation":1,"showOrientationToggles":true,"edgeSize":"Calls","nodeSize":null,"staticNodeSize":100,"colorSettings":{"nodeColorField":"Color","type":2},"hivesMargin":5,"edgeColorSettings":null}},"customWidth":"70","conditionalVisibility":{"parameterName":"correlationId","comparison":"isNotEqualTo","value":""},"name":"query - 5 - Copy - Copy - Copy","styleSettings":{"maxWidth":"70%","showBorder":true}},{"type":3,"content":{"version":"KqlItem/1.0","query":"datatable(Parameter: string, Value: string)\\r\\n[\\r\\n    \\"Correlation ID\\", \\"{correlationId}\\",\\r\\n    \\"Source Name\\", \\"{sourceName}\\",\\r\\n    \\"Process Name\\", \\"{processName}\\",\\r\\n    \\"Target Name\\", \\"{targetName}\\",\\r\\n    \\"Message\\", \\"{message}\\",\\r\\n    \\"status\\", \\"{status}\\"\\r\\n]","size":0,"title":"Details on Line Clicked","timeContext":{"durationMs":86400000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Value","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkIsContextBlade":true}}]}},"customWidth":"30","conditionalVisibility":{"parameterName":"correlationId","comparison":"isNotEqualTo"},"name":"query - 6","styleSettings":{"showBorder":true}},{"type":1,"content":{"json":"<br><br>**OperationId Log**"},"conditionalVisibility":{"parameterName":"correlationId","comparison":"isNotEqualTo"},"name":"text - 13 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AppTraces \\r\\n| where OperationId == \\"{correlationId}\\"","showQuery":true,"size":0,"showAnalytics":true,"timeContextFromParameter":"timerange","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{workspace}"],"gridSettings":{"filter":true}},"conditionalVisibility":{"parameterName":"correlationId","comparison":"isNotEqualTo"},"name":"query - 13"}],"isLocked":false,"fallbackResourceIds":["/subscriptions/${subscription().subscriptionId}/resourcegroups/${resourceGroup().name}/providers/microsoft.insights/components/${appInsightsName}"]}'

resource applicationInsights 'Microsoft.Insights/components@2020-02-02' existing = {
  name: appInsightsName
}

resource workbook 'Microsoft.Insights/workbooks@2023-06-01' = if(length(messageMonitorWorkbookDisplayName) > 0){
  name: guid(appInsightsName, messageMonitorWorkbookDisplayName)
  location: location
  kind: 'shared'
  properties: {
    displayName: messageMonitorWorkbookDisplayName
    sourceId: applicationInsights.id
    version: '1.0'
    serializedData: workbookSerializedData
    category: 'workbook' // Or other categories based on your need
  }
  tags: tags

}
