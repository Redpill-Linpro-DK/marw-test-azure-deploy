name: Deploy to Azure

on:
  push:
    branches:
      - main  # Trigger on push to the main branch

jobs:
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest  # Specify the OS for the job

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3  # Check out the code in the repository

    - name: Load Variables
      uses: ./load-variables.yml
      with:
        variables_dir: "./.github/variables"
        branch: ${{ github.ref_name }}

    - name: Debug Environment Variables
      run: |
        echo ">>> Debugging Environment Variables:"
        cat $GITHUB_ENV

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.DIH_FAIR_AZURE_CREDENTIALS_DEV }}

    - name: Ensure resource group exists and deploy resources
      run: |
        echo ">>> Using variable VAR_LOCATION: $VAR_LOCATION"
        # Ensure the resource group exists
        az group create --name MARWTESTFROMGITHUB --location $VAR_LOCATION

        # Deploy the resources using the Bicep file
        az deployment group create \
          --resource-group MARWTESTFROMGITHUB \
          --template-file main.bicep
